## **Core Protocol Design:**

### 1. **Two-Phase Commit with Beacon Coordination**
- **Phase 1 (PREPARE)**: Source shard locks funds, emits cryptographic receipt
- **Phase 2 (COMMIT)**: Destination shard verifies receipt, credits funds
- **Beacon Chain**: Coordinates finality and provides attestations
- **Finalization**: Source shard releases lock after confirmation

### 2. **Timeout & Rollback Mechanisms**
- **Phase 1 timeout**: 512 blocks (~4 minutes)
- **Phase 2 timeout**: 512 blocks (~4 minutes)
- **Automatic refunds**: After timeout + grace period (64 blocks)
- **Reorg handling**: Proofs reference only finalized blocks

### 3. **Deadlock Prevention**
- **One pending cross-shard tx per account** rule
- **Priority-based ordering** (nonce, fee, deterministic tiebreaker)
- **Exponential backoff** for retries
- **Maximum retry limit**: 5 attempts

### 4. **Lock Management**
- Triple-indexed lock table (by ID, account, expiry)
- Efficient balance queries with locked amounts
- Automatic timeout scanning
- Lock lifecycle tracking

### 5. **Receipt Verification System**
- Separate Receipt Merkle Tree per shard
- Cryptographic receipts with commitments
- Merkle proofs + beacon attestations
- Receipt nullifiers prevent double-redemption

## **Performance Characteristics:**

**Best Case Latency:**
- ~65 seconds (130 blocks) end-to-end
- Dominated by BFT finality requirements (64 blocks each phase)

**Throughput Impact:**
- **2.6% degradation** with 10% cross-shard traffic
- ~48,700 TPS effective (vs 50K baseline)
- Can handle **~10K sustained cross-shard TPS**

**Storage Overhead:**
- Per shard: ~220 MB (locks + receipts + proofs)
- Beacon: ~76 MB (registry + attestations)

## **Security Properties:**

**Byzantine Resistance:**
- f < N/3 malicious validators tolerated
- Lock proofs prevent fake locks
- Beacon attestations require ≥2/3 signatures
- Receipt nullifiers prevent replay

**Privacy Guarantees:**
- Amounts encrypted end-to-end (ML-KEM)
- Validators can't link sender/recipient across shards
- Commitments hide amounts from all observers
- Timing attack mitigations (random delays, dummy txs)

## **What Should We Address Next?**

We've now covered three major components:
1. ✅ State Transition Model
2. ✅ Transaction Format & Lifecycle  
3. ✅ Cross-Shard Atomicity

