
## **WASM VM Candidates for Ecliptica**

### **1. Wasmtime (Recommended)**

**Pros:**
- ✅ **Deterministic execution** (can disable non-deterministic features)
- ✅ **Production-ready** (used by Fastly, Shopify, etc.)
- ✅ **Excellent Rust integration** (same ecosystem as Ecliptica)
- ✅ **Gas metering** (via instrumentation)
- ✅ **Sandboxing** (strong isolation guarantees)
- ✅ **Performance** (Cranelift JIT compiler)
- ✅ **Active development** (Bytecode Alliance)
- ✅ **WASI support** (can be disabled for determinism)

**Cons:**
- ⚠️ Need to carefully configure for determinism (disable floats, WASI, etc.)
- ⚠️ JIT compilation non-deterministic (use AOT or interpreter mode)

**Why it fits Ecliptica:**
- Battle-tested in production blockchain environments
- Can be configured for strict determinism
- Excellent tooling for gas metering and resource limits
- Strong sandboxing (no syscalls, controlled memory)

### **2. Wasmer**

**Pros:**
- ✅ Multiple compiler backends (Singlepass, Cranelift, LLVM)
- ✅ Good performance
- ✅ Metering support
- ✅ Rust-native

**Cons:**
- ⚠️ Less adoption in blockchain space
- ⚠️ More complex API
- ⚠️ Determinism configuration more involved

### **3. CosmWasm (Built on Wasmer)**

**Pros:**
- ✅ **Purpose-built for blockchain** (Cosmos ecosystem)
- ✅ **Deterministic by design**
- ✅ **Gas metering built-in**
- ✅ **Storage abstractions** (KV store interface)
- ✅ **Proven in production** (Terra, Osmosis, etc.)
- ✅ **Actor model** (message passing between contracts)

**Cons:**
- ⚠️ Cosmos-specific design patterns
- ⚠️ Would need significant adaptation for Ecliptica's privacy model
- ⚠️ No native encrypted state support

### **4. wasm3 (Interpreter)**

**Pros:**
- ✅ Pure interpreter (fully deterministic)
- ✅ Tiny footprint
- ✅ No JIT complexity

**Cons:**
- ❌ **Much slower** (~20x slower than JIT)
- ❌ Not suitable for high-throughput blockchain

---

## **Recommendation: Wasmtime + Custom Privacy Layer**

**Architecture:**

```
┌─────────────────────────────────────────────────┐
│         Ecliptica Smart Contract Layer          │
├─────────────────────────────────────────────────┤
│                                                  │
│  ┌────────────────────────────────────────┐     │
│  │   Contract SDK (Rust → WASM)           │     │
│  │   - Encrypted state access             │     │
│  │   - ML-KEM encryption primitives       │     │
│  │   - zk-STARK proof generation          │     │
│  └────────────────────────────────────────┘     │
│              ↓ compile                           │
│  ┌────────────────────────────────────────┐     │
│  │   WASM Bytecode (deterministic)        │     │
│  └────────────────────────────────────────┘     │
│              ↓ execute                           │
│  ┌────────────────────────────────────────┐     │
│  │   Wasmtime Runtime (configured)        │     │
│  │   - No floats, no WASI, no non-det     │     │
│  │   - Gas metering (instrumented)        │     │
│  │   - Memory limits (sandboxed)          │     │
│  └────────────────────────────────────────┘     │
│              ↓ host calls                        │
│  ┌────────────────────────────────────────┐     │
│  │   Host Environment (Ecliptica)         │     │
│  │   - Encrypted storage interface        │     │
│  │   - ML-KEM encryption/decryption       │     │
│  │   - State root updates                 │     │
│  │   - Cross-contract calls               │     │
│  └────────────────────────────────────────┘     │
│              ↓ persist                           │
│  ┌────────────────────────────────────────┐     │
│  │   Encrypted Contract State (on-chain)  │     │
│  │   - Key-value store (encrypted)        │     │
│  │   - Access control via viewing keys    │     │
│  │   - zk proofs of state changes         │     │
│  └────────────────────────────────────────┘     │
│                                                  │
└──────────────────────────────────────────────────┘
```

---

## **Key Configuration for Wasmtime**

```rust
use wasmtime::*;

fn configure_wasmtime_for_ecliptica() -> Result<Engine> {
    let mut config = Config::new();
    
    // 1. CRITICAL: Disable all non-deterministic features
    config.wasm_simd(false);              // SIMD can be non-deterministic
    config.wasm_bulk_memory(true);        // Deterministic, useful
    config.wasm_multi_value(true);        // Deterministic
    config.wasm_reference_types(false);   // Adds complexity
    config.wasm_threads(false);           // Non-deterministic
    config.wasm_multi_memory(false);      // Not needed
    
    // 2. Use interpreter or AOT (not JIT)
    config.strategy(Strategy::Cranelift)?; // AOT compilation
    config.cranelift_opt_level(OptLevel::SpeedAndSize)?;
    
    // 3. Deterministic compilation
    config.cranelift_nan_canonicalization(true);
    
    // 4. Resource limits
    config.max_wasm_stack(1024 * 1024)?;  // 1 MB stack
    config.allocation_strategy(InstanceAllocationStrategy::Pooling {
        strategy: PoolingAllocationStrategy::default(),
        instance_limits: InstanceLimits {
            count: 1000,
            memory_pages: 1024,           // 64 MB max memory
            table_elements: 10_000,
        },
    });
    
    // 5. No WASI (determinism)
    // Don't add WASI to linker
    
    // 6. Gas metering via instrumentation
    config.consume_fuel(true)?;
    
    Ok(Engine::new(&config)?)
}
```

---

## **Privacy-Preserving Smart Contract Model**

### **Key Design Decisions:**

1. **Encrypted State Storage**
   - All contract storage encrypted with ML-KEM
   - Keys derived from contract address + user viewing keys
   - State commitments on-chain (like Ecliptica accounts)

2. **Access Control**
   - Viewing keys grant read access
   - Spending keys grant write access
   - Selective disclosure (per-storage-key permissions)

3. **Cross-Contract Calls**
   - Message passing with encrypted parameters
   - zk proofs of valid state transitions
   - No direct state reads (prevents leakage)

4. **Gas Metering**
   - Deterministic gas costs
   - Extra gas for encryption operations
   - Extra gas for zk proof verification

---

## **Comparison with Alternatives:**

| VM           | Determinism         | Performance | Blockchain-Ready | PQ-Friendly          |
| ------------ | ------------------- | ----------- | ---------------- | -------------------- |
| **Wasmtime** | ⭐⭐⭐⭐ (configurable) | ⭐⭐⭐⭐⭐       | ⭐⭐⭐⭐             | ⭐⭐⭐⭐⭐                |
| **CosmWasm** | ⭐⭐⭐⭐⭐               | ⭐⭐⭐⭐        | ⭐⭐⭐⭐⭐            | ⭐⭐⭐ (needs PQ layer) |
| **Wasmer**   | ⭐⭐⭐                 | ⭐⭐⭐⭐⭐       | ⭐⭐⭐              | ⭐⭐⭐⭐                 |
| **wasm3**    | ⭐⭐⭐⭐⭐               | ⭐⭐          | ⭐⭐               | ⭐⭐⭐⭐⭐                |

