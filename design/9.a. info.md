## **Architecture Overview:**

### 1. **Wasmtime Configuration (Deterministic)**
**Strict Settings:**
- ❌ No SIMD (non-deterministic on some CPUs)
- ❌ No threads (non-deterministic)
- ❌ No floats (non-deterministic NaN handling)
- ❌ No WASI (no syscalls)
- ✅ Bulk memory (deterministic)
- ✅ Multi-value returns (deterministic)
- ✅ Fuel metering (gas)
- ✅ Pooling allocator (128 MB max per contract)

### 2. **Host Functions (17 Total)**

**Storage (3):**
- `storage_read` - Read encrypted value (5,000 gas)
- `storage_write` - Write encrypted value (20,000 gas)
- `storage_remove` - Delete value (20,000 gas)

**Cryptography (4):**
- `crypto_encrypt` - ML-KEM-512 encryption (10,000 gas)
- `crypto_decrypt` - ML-KEM-512 decryption (10,000 gas)
- `crypto_sign` - ML-DSA signing (15,000 gas)
- `crypto_verify` - ML-DSA verification (8,000 gas)

**Blockchain Context (3):**
- `get_caller` - Current caller address
- `get_block_height` - Current block height
- `get_block_timestamp` - Current timestamp

**Inter-Contract (2):**
- `call_contract` - Call another contract (50,000 gas base)
- `emit_event` - Emit encrypted event (1,000 gas)

### 3. **Encrypted Storage Layer**

**Architecture:**
```rust
Contract Address → Storage Key Derivation (SHAKE-256)
                → AES-GCM Encryption
                → RocksDB Backend
```

**Key Features:**
- All values encrypted at rest with contract-specific key
- In-memory cache for performance
- Viewing keys for selective disclosure
- Storage key = SHAKE-256(contract_addr || key)

**Viewing Keys:**
- Derived from user secret + contract address
- Granular permissions (all keys vs specific keys)
- Cannot modify, only read
- Perfect for auditors, regulators

### 4. **Contract SDK (Rust Developer API)**

**Macros:**
```rust
#[contract]              // Auto-generates serialization
#[contract_impl]         // Auto-generates entry points
```

**Example Usage:**
```rust
use ecliptica_contract_sdk::*;

#[contract]
pub struct Counter {
    count: u64,
}

#[contract_impl]
impl Counter {
    pub fn new() -> Self {
        Self { count: 0 }
    }
    
    pub fn increment(&mut self) {
        self.count += 1;
    }
    
    pub fn get_count(&self) -> u64 {
        self.count
    }
}
```

**SDK Modules:**
- `storage::` - Read/write encrypted storage
- `crypto::` - ML-KEM, ML-DSA operations
- `context::` - Blockchain context (caller, height, timestamp)
- `contract::` - Inter-contract calls, events

### 5. **Gas Model**

**Host Function Costs:**
- Storage read: 5,000
- Storage write: 20,000
- ML-KEM encrypt/decrypt: 10,000 each
- ML-DSA sign: 15,000
- ML-DSA verify: 8,000
- Contract call base: 50,000
- Event emission: 1,000

**WASM Instruction Costs:**
- Basic instructions: 1 gas
- Memory load/store: 3 gas
- Multiplication: 4 gas
- Division: 16 gas
- Function call: 10 gas
- Memory grow: 1,000 gas per page (64 KB)

### 6. **Security Features**

**Reentrancy Protection:**
- Track call stack depth
- Detect circular calls
- Max depth: 10 calls

**DoS Protection:**
- Max contract size: 1 MB
- Max storage per contract: 10 MB
- Max execution time: 10 seconds
- Gas limits enforced

**WASM Validation:**
- No floats allowed
- No threads allowed
- No start function
- No imports except "env"
- Memory limits checked

### 7. **Privacy-Preserving Features**

**Encrypted State:**
- All storage values encrypted with ML-KEM
- Keys derived from contract address
- Commitments for zero-knowledge proofs
- Viewing keys for selective disclosure

**Private Token Example:**
```rust
// Balances stored as:
HashMap<Address, EncryptedBalance> where
EncryptedBalance = {
    ciphertext: Vec<u8>,      // ML-KEM encrypted
    commitment: [u8; 32],     // Pedersen commitment
}
```

**Transfer with zk-Proof:**
- Prove sufficient balance (zero-knowledge)
- Update encrypted balances
- Emit encrypted event
- No amounts visible on-chain

### 8. **Performance Benchmarks**

**Throughput:**
- Empty contract call: 10,000 TPS
- Token transfer (encrypted): 125 TPS
- Storage operations: 500-2,000 ops/s

**Latency:**
- Contract call: 0.1ms
- Storage read: 0.5ms
- Storage write: 2ms
- Encrypted transfer: 8ms

**vs Ethereum EVM:**
- 666× faster throughput (10K vs 15 TPS)
- 7× higher gas cost (privacy overhead)
- Native encrypted state (EVM has none)
- Post-quantum secure (EVM is not)

### 9. **Complete Example: Private Voting**

The specification includes a full private voting contract demonstrating:
- Encrypted vote tallies
- Vote commitments (prevent double-voting)
- Zero-knowledge vote proofs
- Admin-only result viewing
- Time-based voting deadlines

### 10. **Contract Deployment**

**Process:**
1. Developer writes Rust contract
2. Compile to WASM (`cargo build --target wasm32`)
3. Optimize with wasm-opt (deterministic only)
4. Deploy with initial state
5. Contract address assigned (deterministic)

### **11. Contract Upgrade Mechanism**
- Proxy pattern implementation for upgradeable contracts
- State migration framework with versioning
- Examples of how to safely migrate between contract versions

### **12. Testing Framework**
- Unit testing with mock environments
- Integration testing for cross-contract interactions
- Fuzzing setup for security testing

### **13. Developer Tools**
- CLI commands for building, deploying, and interacting with contracts
- Development server with hot reload
- Interactive console

### **14. RPC API**
- Complete JSON-RPC interface for contract queries
- Read-only contract calls
- Gas estimation endpoints
- Event querying

### **15. Complete Example: Private Voting**
- Full implementation of an anonymous voting contract
- Demonstrates encrypted state, ZK proofs, and viewing keys
- Includes vote commitments to prevent double-voting

### **16. Best Practices**
- Security guidelines (DOs and DON'Ts)
- Gas optimization patterns
- Privacy best practices with viewing keys

### **17. Future Enhancements**
- 4-phase roadmap through 2027
- Research directions (MPC, FHE, optimistic execution)
- Scalability improvements

### **Appendices:**
- **Appendix A:** Complete gas cost schedule
- **Appendix B:** Comprehensive error codes (100-899)
- **Appendix C:** Reference to example contracts repository

